name: Publish

on:
  push:
    branches:
      - main

jobs:
  build_and_publish:
    name: Build and Publish to GCS
    runs-on: ubuntu-latest

    env:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Build
      uses: docker://forestryio/hugo:node12
      env:
        HUGO_VERSION: 0.79.1
      with:
        # Interestingly, a shell-style subst also works here, but it's not GH Actions doing it, so my theory is that it's passed verbatim to docker, but the entrypoint is bash, which evalates this string as a shell expression and does the expansion cause it's in the runner's env
        args: hugo --enableGitInfo -b https://${{ secrets.GCS_BUCKET }} -s . -d public

    # TODO put build command into an npm script, use yarn run here and forestry (see forestry for command ref)
    # TODO Separate stages into jobs, depend, badges

    - name: Setup gcloud / gsutil
      uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        project_id: ${{ secrets.GCP_PROJECT }}
        service_account_key: ${{ secrets.GCS_SA_KEY }}
        export_default_credentials: true

    - name: Deploy
      run: |-
        gsutil -m rsync -R public gs://$GCS_BUCKET
